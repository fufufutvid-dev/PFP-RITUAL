import React, { useState, useRef } from 'react';
import { Upload, Download, Wand2, RotateCcw } from 'lucide-react';

export default function RitualPFPGenerator() {
  const [uploadedImage, setUploadedImage] = useState(null);
  const [generatedImages, setGeneratedImages] = useState([]);
  const [isLoading, setIsLoading] = useState(false);
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);

  const handleImageUpload = (e) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setUploadedImage(event.target.result);
        setGeneratedImages([]);
      };
      reader.readAsDataURL(file);
    }
  };

  const drawRitualLogo = (ctx, x, y, size, rotation, opacity, color) => {
    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(rotation);
    ctx.globalAlpha = opacity;

    const scale = size / 400;
    ctx.scale(scale, scale);

    // Main ritual logo - complex interlocking pattern
    ctx.fillStyle = color;
    ctx.strokeStyle = color;
    ctx.lineWidth = 2 / scale;

    // Top diamond
    ctx.fillRect(-30, -130, 60, 60);
    ctx.fillRect(-50, -160, 20, 20);
    ctx.fillRect(30, -160, 20, 20);

    // Upper left section
    ctx.fillRect(-140, -60, 60, 60);
    ctx.fillRect(-120, -40, 20, 20);
    ctx.fillRect(-120, -80, 20, 20);

    // Upper right section
    ctx.fillRect(80, -60, 60, 60);
    ctx.fillRect(100, -40, 20, 20);
    ctx.fillRect(100, -80, 20, 20);

    // Middle left
    ctx.fillRect(-100, 20, 60, 60);
    ctx.fillRect(-80, 40, 20, 20);
    ctx.fillRect(-80, 0, 20, 20);

    // Center
    ctx.fillRect(-30, 50, 60, 60);
    ctx.fillRect(-10, 70, 20, 20);
    ctx.fillRect(-50, 70, 20, 20);

    // Middle right
    ctx.fillRect(40, 20, 60, 60);
    ctx.fillRect(60, 40, 20, 20);
    ctx.fillRect(60, 0, 20, 20);

    // Bottom sections
    ctx.fillRect(-120, 130, 60, 60);
    ctx.fillRect(-100, 150, 20, 20);

    ctx.fillRect(60, 130, 60, 60);
    ctx.fillRect(80, 150, 20, 20);

    // Bottom center
    ctx.fillRect(-30, 180, 60, 60);

    ctx.restore();
  };

  const generateRitualEffects = async () => {
    if (!uploadedImage) return;
    setIsLoading(true);

    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = () => {
      const variations = [];

      for (let i = 0; i < 4; i++) {
        canvas.width = 512;
        canvas.height = 512;

        // Draw base image
        ctx.drawImage(img, 0, 0, 512, 512);

        // Apply different ritual effects with logo overlay
        switch (i) {
          case 0:
            applyGlitchEffect(ctx, canvas);
            break;
          case 1:
            applyArcaneCircles(ctx, canvas);
            break;
          case 2:
            applyShadowRitual(ctx, canvas);
            break;
          case 3:
            applyEnergyAura(ctx, canvas);
            break;
        }

        variations.push(canvas.toDataURL('image/png'));
      }

      setGeneratedImages(variations);
    };

    img.src = uploadedImage;
    setTimeout(() => setIsLoading(false), 800);
  };

  const applyGlitchEffect = (ctx, canvas) => {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    for (let i = 0; i < data.length; i += 4) {
      const rand = Math.random();
      if (rand > 0.98) {
        data[i] = Math.random() * 255;
        data[i + 1] = Math.random() * 255;
        data[i + 2] = Math.random() * 255;
      }
    }

    ctx.putImageData(imageData, 0, 0);

    // Add glitch lines
    for (let j = 0; j < 20; j++) {
      const y = Math.random() * canvas.height;
      const h = Math.random() * 20;
      ctx.fillStyle = `rgba(255, 0, 0, ${Math.random() * 0.3})`;
      ctx.fillRect(0, y, canvas.width, h);
    }

    // Draw ritual logo with white glow
    ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
    ctx.shadowBlur = 20;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = 0;
    drawRitualLogo(ctx, 256, 256, 180, 0, 0.9, 'rgba(255, 255, 255, 0.8)');
    
    // Second layer with red tint
    drawRitualLogo(ctx, 256, 256, 180, Math.random() * 0.1, 0.3, 'rgba(255, 0, 0, 0.5)');
  };

  const applyArcaneCircles = (ctx, canvas) => {
    // Create circular overlay
    const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 400);
    gradient.addColorStop(0, 'rgba(255, 255, 255, 0.1)');
    gradient.addColorStop(0.7, 'rgba(138, 43, 226, 0.15)');
    gradient.addColorStop(1, 'rgba(0, 0, 0, 0.3)');

    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw concentric circles
    ctx.strokeStyle = 'rgba(138, 43, 226, 0.6)';
    ctx.lineWidth = 2;
    for (let i = 50; i < 300; i += 40) {
      ctx.beginPath();
      ctx.arc(256, 256, i, 0, Math.PI * 2);
      ctx.stroke();
    }

    // Draw ritual logo in center with purple glow
    ctx.shadowColor = 'rgba(138, 43, 226, 0.9)';
    ctx.shadowBlur = 30;
    drawRitualLogo(ctx, 256, 256, 200, 0, 0.85, 'rgba(138, 43, 226, 0.9)');
    
    // Add white overlay layer
    ctx.shadowColor = 'transparent';
    drawRitualLogo(ctx, 256, 256, 200, 0, 0.3, 'rgba(255, 255, 255, 0.6)');
  };

  const applyShadowRitual = (ctx, canvas) => {
    // Darken and add shadow overlay
    ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Add shadow vignette
    const vignette = ctx.createRadialGradient(256, 256, 0, 256, 256, 450);
    vignette.addColorStop(0, 'rgba(0, 0, 0, 0)');
    vignette.addColorStop(1, 'rgba(0, 0, 0, 0.6)');
    ctx.fillStyle = vignette;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Add red border frame
    ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.rect(20, 20, 472, 472);
    ctx.stroke();

    // Draw ritual logo with red glow
    ctx.shadowColor = 'rgba(255, 0, 0, 0.8)';
    ctx.shadowBlur = 25;
    drawRitualLogo(ctx, 256, 256, 190, 0, 0.8, 'rgba(255, 100, 100, 0.9)');
    
    // Dark shadow layer
    ctx.shadowColor = 'transparent';
    drawRitualLogo(ctx, 256, 256, 190, 0, 0.2, 'rgba(0, 0, 0, 0.8)');
  };

  const applyEnergyAura = (ctx, canvas) => {
    // Add energy glow
    const glow = ctx.createRadialGradient(256, 256, 100, 256, 256, 300);
    glow.addColorStop(0, 'rgba(0, 255, 255, 0.2)');
    glow.addColorStop(1, 'rgba(0, 100, 255, 0.1)');
    ctx.fillStyle = glow;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Add energy waves
    ctx.strokeStyle = 'rgba(0, 255, 255, 0.7)';
    ctx.lineWidth = 2;
    for (let i = 0; i < 3; i++) {
      ctx.beginPath();
      ctx.arc(256, 256, 120 + i * 40, 0, Math.PI * 2);
      ctx.stroke();
    }

    // Add magical particles
    for (let i = 0; i < 30; i++) {
      const x = Math.random() * canvas.width;
      const y = Math.random() * canvas.height;
      ctx.fillStyle = `rgba(0, 255, 255, ${Math.random() * 0.5})`;
      ctx.beginPath();
      ctx.arc(x, y, Math.random() * 3, 0, Math.PI * 2);
      ctx.fill();
    }

    // Draw ritual logo with cyan glow
    ctx.shadowColor = 'rgba(0, 255, 255, 0.9)';
    ctx.shadowBlur = 28;
    drawRitualLogo(ctx, 256, 256, 195, 0, 0.9, 'rgba(0, 255, 255, 0.95)');
    
    // Light overlay
    ctx.shadowColor = 'transparent';
    drawRitualLogo(ctx, 256, 256, 195, 0, 0.2, 'rgba(255, 255, 255, 0.7)');
  };

  const downloadImage = (imageData, index) => {
    const link = document.createElement('a');
    link.href = imageData;
    link.download = `ritual-pfp-${index + 1}.png`;
    link.click();
  };

  return (
    <div className="min-h-screen bg-black text-white overflow-hidden">
      {/* Animated background */}
      <div className="fixed inset-0 -z-10">
        <div className="absolute inset-0 bg-gradient-to-br from-purple-950 via-black to-black opacity-60"></div>
        <div className="absolute top-0 left-1/4 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse"></div>
        <div className="absolute bottom-0 right-1/4 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-10 animate-pulse"></div>
      </div>

      {/* Header */}
      <div className="relative z-10 pt-16 pb-12 text-center">
        <div className="mb-4 flex justify-center">
          <svg className="w-24 h-24" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
            <g opacity="0.95">
              {/* Ritual Logo - Interlocking Pattern */}
              {/* Top diamond */}
              <rect x="170" y="50" width="60" height="60" fill="white" />
              <rect x="150" y="30" width="20" height="20" fill="black" />
              <rect x="230" y="30" width="20" height="20" fill="black" />

              {/* Upper left section */}
              <rect x="80" y="120" width="60" height="60" fill="white" />
              <rect x="100" y="140" width="20" height="20" fill="black" />
              <rect x="100" y="100" width="20" height="20" fill="black" />

              {/* Upper right section */}
              <rect x="260" y="120" width="60" height="60" fill="white" />
              <rect x="280" y="140" width="20" height="20" fill="black" />
              <rect x="280" y="100" width="20" height="20" fill="black" />

              {/* Middle left */}
              <rect x="60" y="190" width="60" height="60" fill="white" />
              <rect x="80" y="210" width="20" height="20" fill="black" />
              <rect x="80" y="170" width="20" height="20" fill="black" />

              {/* Center */}
              <rect x="170" y="190" width="60" height="60" fill="white" />
              <rect x="190" y="210" width="20" height="20" fill="black" />
              <rect x="150" y="210" width="20" height="20" fill="black" />

              {/* Middle right */}
              <rect x="280" y="190" width="60" height="60" fill="white" />
              <rect x="300" y="210" width="20" height="20" fill="black" />
              <rect x="300" y="170" width="20" height="20" fill="black" />

              {/* Bottom left */}
              <rect x="100" y="260" width="60" height="60" fill="white" />
              <rect x="120" y="280" width="20" height="20" fill="black" />

              {/* Bottom right */}
              <rect x="240" y="260" width="60" height="60" fill="white" />
              <rect x="260" y="280" width="20" height="20" fill="black" />

              {/* Bottom center */}
              <rect x="170" y="320" width="60" height="60" fill="white" />
            </g>
          </svg>
        </div>
        <h1 className="text-6xl font-bold bg-gradient-to-r from-purple-400 via-pink-400 to-purple-600 bg-clip-text text-transparent mb-3">
          Ritual PFP
        </h1>
        <p className="text-purple-300 text-lg font-light tracking-widest">GENERATOR</p>
      </div>

      {/* Main Content */}
      <div className="relative z-10 max-w-6xl mx-auto px-6 pb-16">
        <div className="grid md:grid-cols-2 gap-12">
          {/* Upload Section */}
          <div className="space-y-6">
            <div className="backdrop-blur-xl bg-white/5 border border-purple-500/20 rounded-2xl p-8 hover:border-purple-500/40 transition">
              <label className="block">
                <div className="flex flex-col items-center justify-center p-8 border-2 border-dashed border-purple-500/40 rounded-xl cursor-pointer hover:border-purple-500 transition group">
                  <Upload className="w-12 h-12 text-purple-400 group-hover:text-purple-300 mb-3 transition" />
                  <span className="text-lg font-semibold text-purple-300">Upload Your Photo</span>
                  <span className="text-sm text-gray-400 mt-2">or drag and drop</span>
                  <input
                    type="file"
                    className="hidden"
                    accept="image/*"
                    onChange={handleImageUpload}
                    ref={fileInputRef}
                  />
                </div>
              </label>
            </div>

            {uploadedImage && (
              <div className="backdrop-blur-xl bg-white/5 border border-purple-500/20 rounded-2xl p-6">
                <p className="text-sm text-gray-400 mb-3">Original Image</p>
                <img src={uploadedImage} alt="Uploaded" className="w-full rounded-lg border border-purple-500/30" />
              </div>
            )}

            {/* Action Buttons */}
            <div className="space-y-3">
              <button
                onClick={generateRitualEffects}
                disabled={!uploadedImage || isLoading}
                className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-xl transition transform hover:scale-105 flex items-center justify-center gap-2"
              >
                <Wand2 className="w-5 h-5" />
                {isLoading ? 'Generating...' : 'Generate Ritual PFP'}
              </button>

              {generatedImages.length > 0 && (
                <button
                  onClick={() => {
                    setGeneratedImages([]);
                    setUploadedImage(null);
                    fileInputRef.current?.click();
                  }}
                  className="w-full border border-purple-500/40 hover:border-purple-500 text-purple-300 font-semibold py-3 px-6 rounded-xl transition flex items-center justify-center gap-2"
                >
                  <RotateCcw className="w-5 h-5" />
                  Start Over
                </button>
              )}
            </div>
          </div>

          {/* Generated Results */}
          <div>
            {generatedImages.length > 0 ? (
              <div className="space-y-4">
                <p className="text-sm text-gray-400 font-semibold">Generated Variations</p>
                <div className="grid grid-cols-2 gap-4">
                  {generatedImages.map((img, idx) => (
                    <div key={idx} className="group backdrop-blur-xl bg-white/5 border border-purple-500/20 rounded-lg overflow-hidden hover:border-purple-500/60 transition">
                      <div className="relative overflow-hidden">
                        <img src={img} alt={`Ritual PFP ${idx + 1}`} className="w-full aspect-square object-cover" />
                        <button
                          onClick={() => downloadImage(img, idx)}
                          className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center"
                        >
                          <Download className="w-6 h-6 text-white" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <div className="h-full flex items-center justify-center">
                <div className="text-center space-y-4">
                  <div className="w-20 h-20 rounded-full bg-gradient-to-br from-purple-500/20 to-pink-500/20 flex items-center justify-center mx-auto">
                    <Wand2 className="w-10 h-10 text-purple-400 opacity-50" />
                  </div>
                  <p className="text-gray-400">Upload an image and generate your ritual PFP</p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Footer */}
      <div className="relative z-10 border-t border-purple-500/10 mt-20">
        <div className="max-w-6xl mx-auto px-6 py-8 text-center text-sm text-gray-500">
          <p>Created with mystical powers</p>
          <p className="mt-2">
            Creator: <a href="https://x.com/ega_2ez4crypto" target="_blank" rel="noopener noreferrer" className="text-purple-400 hover:text-purple-300 transition">@ega_2ez4crypto</a>
          </p>
        </div>
      </div>

      {/* Hidden canvas for processing */}
      <canvas ref={canvasRef} className="hidden" />
    </div>
  );
}
