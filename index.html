import React, { useState, useRef } from 'react';
import { Upload, Download, RefreshCw, Sparkles, Wand2 } from 'lucide-react';

export default function RitualGenerator() {
  const [uploadedImage, setUploadedImage] = useState(null);
  const [generatedImage, setGeneratedImage] = useState(null);
  const [loading, setLoading] = useState(false);
  const [selectedEffect, setSelectedEffect] = useState('mystical');
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);

  const effects = {
    mystical: { name: 'Mystical Aura', description: 'Glowing ethereal energy' },
    cosmic: { name: 'Cosmic', description: 'Deep space energy' },
    divine: { name: 'Divine Light', description: 'Sacred golden glow' },
    phantom: { name: 'Phantom', description: 'Spectral ethereal form' },
    infernal: { name: 'Infernal', description: 'Fiery chaos energy' },
    celestial: { name: 'Celestial', description: 'Starry dimensional shift' }
  };

  const applyEffect = (ctx, imgData, effectType) => {
    const data = imgData.data;
    
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];

      if (effectType === 'mystical') {
        data[i] = Math.min(255, r * 1.2);
        data[i + 1] = Math.min(255, g * 1.15);
        data[i + 2] = Math.min(255, b * 1.3);
      } else if (effectType === 'cosmic') {
        data[i] = r * 0.8;
        data[i + 1] = Math.min(255, g * 1.1);
        data[i + 2] = Math.min(255, b * 1.3);
      } else if (effectType === 'divine') {
        data[i] = Math.min(255, r * 1.25);
        data[i + 1] = Math.min(255, g * 1.2);
        data[i + 2] = b * 0.9;
      } else if (effectType === 'phantom') {
        const avg = (r + g + b) / 3;
        data[i] = avg * 1.15;
        data[i + 1] = avg * 1.1;
        data[i + 2] = avg * 1.2;
        data[i + 3] = data[i + 3] * 0.95;
      } else if (effectType === 'infernal') {
        data[i] = Math.min(255, r * 1.4);
        data[i + 1] = Math.min(255, g * 0.85);
        data[i + 2] = b * 0.7;
      } else if (effectType === 'celestial') {
        data[i] = Math.min(255, r * 1.1);
        data[i + 1] = Math.min(255, g * 1.2);
        data[i + 2] = Math.min(255, b * 1.35);
      }
    }
    return imgData;
  };

  const handleImageUpload = (e) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        setUploadedImage(event.target?.result);
        setGeneratedImage(null);
      };
      reader.readAsDataURL(file);
    }
  };

  const generateRitual = async () => {
    if (!uploadedImage) return;

    setLoading(true);
    
    setTimeout(() => {
      try {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = () => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          
          const size = 512;
          canvas.width = size;
          canvas.height = size;
          
          const ctx = canvas.getContext('2d');
          if (!ctx) return;
          
          ctx.fillStyle = '#0a0a0a';
          ctx.fillRect(0, 0, size, size);

          const scale = Math.min(size / img.width, size / img.height);
          const x = (size - img.width * scale) / 2;
          const y = (size - img.height * scale) / 2;
          
          ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

          let imageData = ctx.getImageData(0, 0, size, size);
          imageData = applyEffect(ctx, imageData, selectedEffect);
          ctx.putImageData(imageData, 0, 0);

          // Add ritual frame
          ctx.strokeStyle = 'rgba(255, 215, 0, 0.6)';
          ctx.lineWidth = 3;
          ctx.setLineDash([10, 10]);
          ctx.strokeRect(8, 8, size - 16, size - 16);
          ctx.setLineDash([]);

          // Add gradient overlay
          const gradient = ctx.createRadialGradient(size / 2, size / 2, 0, size / 2, size / 2, Math.max(size, size) / 1.5);
          gradient.addColorStop(0, 'rgba(255, 215, 0, 0.1)');
          gradient.addColorStop(1, 'rgba(138, 43, 226, 0.15)');
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, size, size);

          // Add symbols
          const symbols = ['✦', '✧', '◆', '●', '○'];
          ctx.fillStyle = 'rgba(255, 215, 0, 0.5)';
          ctx.font = 'bold 20px serif';
          
          symbols.forEach((sym, i) => {
            const angle = (i / symbols.length) * Math.PI * 2;
            const radius = size / 2.5;
            const px = size / 2 + Math.cos(angle) * radius;
            const py = size / 2 + Math.sin(angle) * radius;
            ctx.save();
            ctx.translate(px, py);
            ctx.rotate(angle);
            ctx.fillText(sym, -5, 5);
            ctx.restore();
          });

          setGeneratedImage(canvas.toDataURL());
          setLoading(false);
        };

        img.onerror = () => {
          setLoading(false);
        };
        
        img.src = uploadedImage;
      } catch (err) {
        setLoading(false);
      }
    }, 800);
  };

  const downloadImage = () => {
    if (!generatedImage) return;
    const a = document.createElement('a');
    a.href = generatedImage;
    a.download = `ritual-pfp-${Date.now()}.png`;
    a.click();
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-black via-purple-900 to-black text-white overflow-hidden">
      {/* Background Effects */}
      <div className="fixed inset-0 opacity-20 pointer-events-none">
        <div className="absolute top-20 left-10 w-72 h-72 bg-purple-500 rounded-full mix-blend-screen filter blur-3xl animate-pulse"></div>
        <div className="absolute bottom-20 right-10 w-72 h-72 bg-violet-600 rounded-full mix-blend-screen filter blur-3xl animate-pulse" style={{animationDelay: '2s'}}></div>
      </div>

      {/* Header */}
      <div className="relative z-10 pt-8 px-6 text-center mb-12">
        <div className="flex items-center justify-center gap-3 mb-4">
          <Wand2 className="w-8 h-8 text-amber-400" />
          <h1 className="text-5xl font-black bg-gradient-to-r from-amber-300 via-purple-300 to-pink-300 bg-clip-text text-transparent">
            RITUAL GENERATOR
          </h1>
          <Sparkles className="w-8 h-8 text-pink-400" />
        </div>
        <p className="text-gray-300 text-lg font-light tracking-widest">Transform Your Avatar Into Sacred Art</p>
      </div>

      <canvas ref={canvasRef} className="hidden" />

      {/* Main Content */}
      <div className="relative z-10 max-w-6xl mx-auto px-6 pb-16">
        <div className="grid md:grid-cols-2 gap-12">
          {/* Left Column - Upload */}
          <div className="space-y-6">
            <div className="bg-gradient-to-br from-purple-900/40 to-black border border-purple-500/30 rounded-2xl p-8 backdrop-blur-lg">
              <div className="flex flex-col items-center justify-center space-y-6">
                <div 
                  onClick={() => fileInputRef.current?.click()}
                  className="w-full aspect-square bg-gradient-to-br from-purple-800/20 to-black border-2 border-dashed border-purple-500/50 rounded-xl cursor-pointer hover:border-amber-400/50 transition-all flex items-center justify-center hover:bg-purple-900/20"
                >
                  {uploadedImage ? (
                    <img src={uploadedImage} alt="Preview" className="w-full h-full object-cover rounded-lg" />
                  ) : (
                    <div className="text-center space-y-3">
                      <Upload className="w-12 h-12 text-purple-400 mx-auto" />
                      <p className="text-gray-300 font-medium">Upload Your Photo</p>
                      <p className="text-gray-500 text-sm">PNG, JPG or GIF</p>
                    </div>
                  )}
                </div>
                <input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleImageUpload}
                  className="hidden"
                />
              </div>
            </div>

            {/* Effect Selection */}
            <div className="space-y-4">
              <h3 className="text-xl font-bold text-amber-300 flex items-center gap-2">
                <Sparkles className="w-5 h-5" />
                Choose Ritual Energy
              </h3>
              <div className="grid grid-cols-2 gap-3">
                {Object.entries(effects).map(([key, effect]) => (
                  <button
                    key={key}
                    onClick={() => setSelectedEffect(key)}
                    className={`p-4 rounded-lg border-2 transition-all text-left ${
                      selectedEffect === key
                        ? 'border-amber-400 bg-amber-400/10'
                        : 'border-purple-500/30 bg-purple-900/20 hover:border-purple-400/60'
                    }`}
                  >
                    <p className="font-semibold text-sm">{effect.name}</p>
                    <p className="text-xs text-gray-400 mt-1">{effect.description}</p>
                  </button>
                ))}
              </div>
            </div>

            {/* Generate Button */}
            <button
              onClick={generateRitual}
              disabled={!uploadedImage || loading}
              className="w-full bg-gradient-to-r from-amber-400 to-pink-500 hover:from-amber-300 hover:to-pink-400 disabled:from-gray-600 disabled:to-gray-600 text-black font-bold py-4 rounded-xl transition-all transform hover:scale-105 disabled:cursor-not-allowed flex items-center justify-center gap-2"
            >
              {loading ? (
                <>
                  <RefreshCw className="w-5 h-5 animate-spin" />
                  Channeling Energy...
                </>
              ) : (
                <>
                  <Sparkles className="w-5 h-5" />
                  Generate Ritual PFP
                </>
              )}
            </button>
          </div>

          {/* Right Column - Preview */}
          <div className="space-y-6">
            <div className="bg-gradient-to-br from-purple-900/40 to-black border border-purple-500/30 rounded-2xl p-8 backdrop-blur-lg">
              <div className="aspect-square bg-gradient-to-br from-purple-800/20 to-black border border-purple-500/50 rounded-xl overflow-hidden flex items-center justify-center">
                {generatedImage ? (
                  <img src={generatedImage} alt="Generated" className="w-full h-full object-contain" />
                ) : (
                  <div className="text-center space-y-3">
                    <Wand2 className="w-12 h-12 text-purple-500/50 mx-auto" />
                    <p className="text-gray-500">Your ritual awaits...</p>
                  </div>
                )}
              </div>
            </div>

            {/* Download Button */}
            {generatedImage && (
              <button
                onClick={downloadImage}
                className="w-full bg-gradient-to-r from-purple-600 to-violet-600 hover:from-purple-500 hover:to-violet-500 text-white font-bold py-4 rounded-xl transition-all transform hover:scale-105 flex items-center justify-center gap-2"
              >
                <Download className="w-5 h-5" />
                Download PFP
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Footer */}
      <div className="relative z-10 border-t border-purple-500/20 mt-16 pt-8 pb-6 px-6 text-center">
        <p className="text-gray-400 text-sm mb-3">Created by talented minds in the crypto realm</p>
        <a 
          href="https://x.com/ega_2ez4crypto" 
          target="_blank" 
          rel="noopener noreferrer"
          className="inline-flex items-center gap-2 text-amber-400 hover:text-amber-300 font-semibold transition-colors"
        >
          <Sparkles className="w-4 h-4" />
          @ega_2ez4crypto
        </a>
      </div>
    </div>
  );
}
